\documentclass{article}

\usepackage{amsmath}
\usepackage{listings}
\usepackage{xcolor}

\lstset{
	language=Python,
	backgroundcolor=\color{white},
	basicstyle=\ttfamily,
	keywordstyle=\color{blue},
	stringstyle=\color{red},
	commentstyle=\color{green},
	numberstyle=\tiny\color{gray},
	numbers=left,
	stepnumber=1,
	numbersep=10pt,
	showstringspaces=false,
	tabsize=4,
}

\begin{document}
	\section{Collision physics}
	\subsection{Collision with the bounds}
	\subsubsection{Rectangular bounds}
	We'll describe the rectangular bounds by their 2 corner points $(x_{min}, y_{min})$ and $(x_{max}, y_{max})$. 
	The circle is at position $(x(t), y(t))$ with radius $R$. The penetration $l$ through the wall is $l > 0$ if the circle is overlapping with the bounds. We set it to 0 to determine the time the circle first collided with the wall to wind back time to that point. Then we'll negate the appropriate coordinate of the velocity and jump forward in time by $\Delta t$.\\
	We have
	\begin{align*}
		\vec{r}(t) &= \begin{pmatrix} x(t) \\ y(t) \end{pmatrix}\\
		&= \begin{pmatrix} x_0 + v_xt \\ y_0 + v_y t \end{pmatrix}
	\end{align*}
	with $(x_0, y_0)$ being the current position of the circle. Using this, we need to calculate the time points of collision for each of the 4 cases. $\Delta t > 0$ will be the time it took the circle to travel $l$ units beyond the wall. 
	
	\subsubsection*{Left wall}
	\begin{align*}
		l(t) &= R + x_{min} - x(t) \overset{!}{=} 0\\
		\Leftrightarrow x_0 + v_x t &= R + x_{min}\\
		\Rightarrow \Delta t &= \frac{R + x_{min} - x_0}{v_x}
	\end{align*}
	\begin{align*}
		\vec{v}' = \begin{pmatrix} -v_x\\ v_y \end{pmatrix}
	\end{align*}
	\begin{align*}
		\Delta \vec{r} = \begin{pmatrix} -v_x \Delta t + v_x' \Delta t\\ -v_y \Delta t + v_y' \Delta t\end{pmatrix} = \begin{pmatrix} -2 \Delta t v_x \\ \Delta t (-v_y + v_y)\end{pmatrix} = \begin{pmatrix} -2 \Delta t v_x \\ 0\end{pmatrix}
	\end{align*}

	\subsubsection*{Right wall}
	\begin{align*}
		l(t) &= R - x_{max} + x(t) \overset{!}{=} 0\\
		\Leftrightarrow x_0 + v_x t &= x_{max} - R\\
		\Rightarrow \Delta t &= -\frac{x_{max} - R - x_0}{v_x}
	\end{align*}
	$\vec{v}'$ and $\Delta \vec{r}$ as above.
	
	\subsubsection*{Top wall}
	\begin{align*}
		l(t) &= R + y_{min} - y(t) \overset{!}{=} 0\\
		\Leftrightarrow y_0 + v_y t &= R + y_{min}\\
		\Rightarrow \Delta t &= \frac{R + y_{min} - y_0}{v_y}
	\end{align*}
	\begin{align*}
		\vec{v}' = \begin{pmatrix} v_x\\ -v_y \end{pmatrix}
	\end{align*}
	\begin{align*}
		\Delta \vec{r} = \begin{pmatrix} -v_x \Delta t + v_x' \Delta t\\ -v_y \Delta t + v_y' \Delta t\end{pmatrix} = \begin{pmatrix} 0 \\ -2 \Delta t v_y\end{pmatrix}
	\end{align*}

	\subsubsection*{Bottom wall}
	\begin{align*}
		l(t) &= R - y_{max} + y(t) \overset{!}{=} 0\\
		\Leftrightarrow y_0 + v_y t &= y_{max} - R\\
		\Rightarrow \Delta t &= -\frac{y_{max} - R - y_0}{v_y}
	\end{align*}
	$\vec{v}'$ and $\Delta \vec{r}$ as above.
	
	\subsection{Overlap between circles}
	The overlap $l$ of 2 circles is the sum of their radii minus the distance between them. If the overlap is $> 0$, we have a collision. The current positions of the circles are $\vec{r}_{i, 0}$.
	\begin{equation}
		l = R_1 + R_2 - \left|\vec{v}_{2, 0} - \vec{v}_{1, 0}\right|
	\end{equation}
	We want to move the circles to the positions they had just before the collision (when they were just touching without intersection). For this, we need to move them back in time using their velocities multiplied with a time $\Delta t$ we have to calculate. At that time, the overlap should be 0:
	
	\begin{align*}
		l(t) &= R_1 + R_2 - \left|\vec{r_2}(t) - \vec{r_1}(t)\right|\\
	 &= R_1 + R_2 - \left|\vec{r}_{2, 0} + t\cdot\vec{v_2} - \vec{r}_{1, 0} - t\cdot\vec{v_1}\right|\\
	 &= R_1 + R_2 - \left|\vec{r}_{2, 0} - \vec{r}_{1, 0} + t\left(\vec{v_2} - \vec{v_1}\right)\right|\\
	 &= R_1 + R_2 - \left|\vec{r} + t\cdot\vec{v}\right| \overset{!}{=} 0\\
	 &\Leftrightarrow \sqrt{\left(\left(r_x+t\cdot v_x\right)^2+\left(r_x+t\cdot v_y\right)^2\right)} = R_1 + R_2\\
	 &\Rightarrow \Delta t = \frac{-r_x v_x - r_y v_y \pm \sqrt{-r_x^2 v_y^2 + 2 r_x r_y v_x v_y - r_y^2 v_x^2 + (R_1 + R_2)^2 (v_x^2 + v_y^2)}}{v_x^2 + v_y^2}
	\end{align*}

	with distance vector $\vec{r} = \vec{r_{2, 0}} - \vec{r_{1, 0}}$ and relative velocity $\vec{v} = \vec{v_2} - \vec{v_1}$ of the circles. The 2 solutions for $\Delta t$ refer to the first point of contact before overlap and the point in time exactly after the circles have passed through each other. The first contact happens at an earlier time, so we'll select the earlier of the 2 solutions, the one with $-\sqrt{...}$.\\
	Now the correct initial positions $\vec{r}_{i, c}$ at the time of collision can easily be calculated:
	\begin{equation}
		\vec{r}_{i, c} =\vec{r}_{i, 0} + \Delta t \cdot \vec{v}_i
	\end{equation}
	After the collision was handled and the new velocities $\vec{v}'_i$ have been calculated, the circles need to be winded forward in time with their corrected velocities:
	\begin{equation}
		\vec{r}_{i} =\vec{r}_{i, c} - \Delta t \cdot \vec{v}'_i
	\end{equation}
	
	\begin{lstlisting}[caption={Code to calculate $t$}]
from sympy import symbols, Eq, solve, simplify, sqrt

rx, ry, vx, vy, R1, R2, t = symbols("rx ry vx vy R1 R2 t")
eq = Eq(sqrt((rx + t*vx)**2+(ry+t*vy)**2), R1+R2)
solution = solve(eq, t)

simplified = [simplify(sol) for sol in solution]

for sol in simplified:
print(sol)
	\end{lstlisting}

	\subsection{Collision handling}
		
	For a collision of 2 circles with masses $m_i$ and velocities $v_{i-}$ before and $v_{i+}$ after the collision, we obtain the following equations\footnote{See Bourg, David M.; Bywalec, Bryan: Physics for Game Developers, O'REILLY, Second Edition, p. 112}:
	
	\begin{align*}
		\Delta \vec{p} &= m_1\left(\vec{v}_{1+} - \vec{v}_{1-}\right),\\
		-\Delta \vec{p} &= m_2\left(\vec{v}_{2+} - \vec{v}_{2-}\right),\\
		e &= -\frac{v_{1+} - v_{2+}}{v_{1-} - v_{2-}}.
	\end{align*}

	$e$ is the coefficient of restitution, a value in the interval $[0, 1]$ where $1$ indicates a completely elastic collision (the deformed objects "bounce" back completely after the collision) and $0$ indicates an inelastic collision. In atomic collisions, no deformations occur and $e = 1$.\\
	$\Delta p$ is the impulse that changes the momentums of both circles along the line of action.\\
	After solving the first equations for $\vec{v}_{1+}$ and $\vec{v}_{2+}$, these values are substituted in the last equation:
	
	\begin{align*}
		&\vec{v}_{1+} = \frac{\Delta \vec{p}}{m_1} + \vec{v}_{1-} \Rightarrow v_{1+} = \frac{\Delta p}{m_1} + v_{1-}\\
		&\vec{v}_{2+} = -\frac{\Delta \vec{p}}{m_2} + \vec{v}_{2-} \Rightarrow v_{2+} = -\frac{\Delta p}{m_2} + v_{2-}\\
		&\Rightarrow e = -\frac{\frac{\Delta p}{m_1} + v_{1-} - \left(-\frac{\Delta \vec{p}}{m_2} + v_{2-}\right)}{v_{1-} - v_{2-}}\\
		&\Leftrightarrow e\left(v_{1-} - v_{2-}\right) = -\left(v_{1-} - v_{2-} + \Delta p\left(\frac{1}{m_1} + \frac{1}{m_2}\right)\right)\\
		&\Leftrightarrow -ev_r = v_r - \Delta p\left(\frac{1}{m_1} + \frac{1}{m_2}\right)\\
		&\Leftrightarrow \Delta p\left(\frac{1}{m_1} + \frac{1}{m_2}\right) = v_r + ev_r\\
		&\Leftrightarrow \Delta p = \frac{v_r(e + 1)}{\frac{1}{m_1} + \frac{1}{m_2}}
	\end{align*}

	with the relative veloctiy $\vec{v}_r = \vec{v}_{2-} - \vec{v}_{1-}$. The impulse $\Delta p$ acts along the line of action connecting the center of masses of both circles, so we'll need the normal vector $\vec{n}$ along the collision:
	
	\begin{align*}
		\vec{n} = \frac{\vec{r}_2 - \vec{r}_1}{|\vec{r}_2 - \vec{r}_1|}.
	\end{align*}

	With this, the new velocities are
	
	\begin{align*}
		&\vec{v}_{1+} = \vec{v}_{1-} - \frac{\Delta p}{m_1}\vec{n},\\
		&\vec{v}_{2+} = \vec{v}_{2-} + \frac{\Delta p}{m_2}\vec{n}.
	\end{align*}

	\section{Reactions}
	
	\subsection{Decomposition: $A \rightarrow B + C$}
	
	A is moving with $\vec{r}_A(t)$. B and C move in opposite directions away from where A was, conserving energy and impulse.
	

\end{document}